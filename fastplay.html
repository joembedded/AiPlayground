<!DOCTYPE html>
<html lang="en">
<!-- http://localhost/wrk/ai/playground/fastplay.html -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    FAST - Audio-Test<br>
    <audio controls ></audio><br>
    <button id="laden">Neu Laden & Play</button><br>
    <hr>
    <h3>Verfügbare Audiodateien (speech):</h3>
    <div id="audioList">Lade Dateiliste...</div>
    <hr>
    <div id="log"></div>
</body>
<script>
    const audio = document.querySelector('audio');
    const logDiv = document.getElementById('log');
    logDiv.innerHTML += 'Starte Test...<br>';

    // Abspielen sobald möglich
    audio.addEventListener('canplay', function () {
        logDiv.innerHTML += 'Spiele Audio ab...<br>';
        audio.play().catch(error => {
            logDiv.innerHTML += 'Autoplay prevented: ' + error;
        });
    });

    document.getElementById('laden').addEventListener('click', () => {
        logDiv.innerHTML += 'Lade Audio-Datei...<br>';
        audio.src = './api/oai_tts.php?text=' + encodeURIComponent('Dies ist ein einfacher Test der Sprachausgabe mit der OpenAI API. Wir prüfen, ob die Audioausgabe korrekt funktioniert.') + '&voice=narrator_m_vilo&stream=1';
        audio.load();
    });
    // Fehlerbehandlung für Audio-Quelle - Wichtig!
    audio.addEventListener('error', function () {
        console.error('Audio-Fehler:', audio.error);
        logDiv.innerHTML += 'Audio-Fehler: ' + (audio.error ? audio.error.message : 'Unbekannter Fehler') + '<br>';
    });

    // Audiodatei-Liste laden - -Auto-Generated-
    async function loadAudioList() {
        const audioListDiv = document.getElementById('audioList');
        try {
            const response = await fetch('./api/oai_listaudio.php?dir=audio/speech');
            if (!response.ok) {
                throw new Error(`HTTP-Fehler: ${response.status} ${response.statusText}`);
            }

            // Aufm Live-Server liefert PHP sich selbst...
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Ungültige Antwort: Kein JSON-Format erhalten');
            }
            
            const data = await response.json();
            
            if (data.error) {
                audioListDiv.innerHTML = 'Fehler-AudioList: ' + data.error;
                return;
            }
            
            // Liste erstellen
            let html = `<div style="max-height: 400px; overflow-y: auto;">`;
            html += `<p><strong>${data.count} Dateien gefunden</strong></p>`;
            html += '<ul style="list-style: none; padding: 0;">';
            
            data.files.forEach(file => {
                const filePath = `audio/speech/${file.filename}`;
                const sizeKB = Math.round(file.size / 1024);
                html += `<li style="margin: 2px 0; padding: 2px; background: #f0f0f0; cursor: pointer;" 
                         onclick="playAudioFile('${filePath}')">
                    <strong>${file.filename}</strong><br>
                    <small>Größe: ${sizeKB} KB | Geändert: ${file.modified}</small>
                </li>`;
            });
            
            html += '</ul></div>';
            audioListDiv.innerHTML = html;
            
        } catch (error) {
            audioListDiv.innerHTML = 'Fehler beim Laden der Liste: ' + error.message;
            console.error('Fehler:', error);
        }
    }
    
    // Audiodatei abspielen
    function playAudioFile(filePath) {
        logDiv.innerHTML += `Spiele: ${filePath}<br>`;
        audio.src = './' + filePath;
        audio.load();
    }
    
    // Liste beim Laden der Seite abrufen
    loadAudioList();

</script>

</html>