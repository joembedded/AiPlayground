<!DOCTYPE html>
<!-- http://localhost/wrk/ai/playground/testspeak.html -->
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div>
        <h1>Text-to-Speech mit OpenAI API</h1>
        Mit Streaming etwas schlechtere Qualität, aber schnellere Wiedergabe.
    </div>
    <hr>
    <div id="info">Teste die Sprachausgabe...

    </div>
    <div><textarea id="textInput" rows="10" cols="80">
Die Liebe ist langmütig und freundlich, 
die Liebe eifert nicht, 
die Liebe treibt nicht Mutwillen, 
sie bläht sich nicht auf, 
sie verhält sich nicht ungehörig, 
sie sucht nicht das Ihre, 
sie lässt sich nicht erbittern, 
sie rechnet das Böse nicht zu.
    1 Korinther 13:4-5
    </textarea></div>
    <div>
        <label>Voice: 
            <select id="voiceSelect">
                <option value="narrator_m_vilo">narrator_m_vilo</option>
                <option value="narrator_f_jane">narrator_f_jane</option>
                <option value="narrator_m_jack">narrator_m_jack</option>
            </select>
        </label>
    </div>
    <div><label><input type="checkbox" id="streamCheckbox"> Stream</label></div>
    <button onclick="speak(document.getElementById('textInput').value)">Sprich</button>
    <!-- Audio-Element geht nicht kleiner. Nur kopmplett hidden , Autoplay wohl wichtig! -->
    <audio id="player" controls autoplay></audio>
    <script>
        const infoDiv = document.getElementById("info");
        async function speak(text) {
            try {
                infoDiv.innerText = "Warte auf Audio...";
                const form = new FormData();
                form.append("text", text);
                const selectedVoice = document.getElementById("voiceSelect").value;
                form.append("voice", selectedVoice);
                const streamEnabled = document.getElementById("streamCheckbox").checked;
                if (streamEnabled) {
                    form.append("stream", "1");
                }
                const res = await fetch("./api/oai_tts.php", { method: "POST", body: form });
                if (!res.ok)   throw new Error(`HTTP-Fehler: ${res.status} ${res.statusText}`);
                
                infoDiv.innerText = "Sprachausgabe erhalten, spiele ab...";
                const blob = await res.blob();
                infoDiv.innerText = "Fertig!";
                const player = document.getElementById("player");
                player.src = URL.createObjectURL(blob);
                if (!streamEnabled) { // Manuell anwerfen, wenn nicht gestreamt wird
                    infoDiv.innerText = "Play!";
                    player.play();
                }
            } catch (error) {
                infoDiv.innerText = "Fehler: " + error.message;
            }
        }

    </script>
</body>

</html>